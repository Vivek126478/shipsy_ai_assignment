<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { width: 100%; border-collapse: collapse; margin-top: 1em;}
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .form-container { padding: 20px; border: 1px solid #ccc; margin-bottom: 20px; }
        .logout { float: right; }
        .controls { margin-bottom: 1em; display: flex; align-items: center; gap: 20px;}
        .pagination { margin-top: 1em; text-align: center; }
        .pagination button { margin: 0 5px; }
    </style>
</head>
<body>

    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    <h1>Welcome, {{ user.username }}!</h1>
    <p>Track and manage your expenses below.</p>

    <!-- Form for Adding/Editing Expenses -->
    <div class="form-container">
        <h2 id="form-title">Add New Expense</h2>
        <form id="expense-form">
            <input type="hidden" id="expense-id">
            
            <label for="description">Description:</label><br>
            <input type="text" id="description" name="description" required size="50"><br><br>

            <label for="base_amount">Base Amount ($):</label><br>
            <input type="number" id="base_amount" name="base_amount" step="0.01" required><br><br>

            <label for="tax_amount">Tax Amount ($):</label><br>
            <input type="number" id="tax_amount" name="tax_amount" step="0.01" value="0.00" required><br><br>

            <label for="category">Category:</label><br>
            <select id="category" name="category" required>
                {% for cat in categories %}
                <option value="{{ cat.upper() }}">{{ cat }}</option>
                {% endfor %}
            </select><br><br>

            <input type="checkbox" id="is_reimbursable" name="is_reimbursable">
            <label for="is_reimbursable">Is this reimbursable?</label><br><br>

            <button type="submit">Save Expense</button>
            <button type="button" id="cancel-edit" style="display:none;">Cancel Edit</button>
        </form>
    </div>

    <!-- Controls for Filtering -->
    <h2>Your Expenses</h2>
    <div class="controls">
        <label for="filter-category">Filter by Category:</label>
        <select id="filter-category">
            <option value="ALL">All</option>
             {% for cat in categories %}
             <option value="{{ cat.upper() }}">{{ cat }}</option>
             {% endfor %}
        </select>
    </div>

    <!-- Table to Display Expenses -->
    <table id="expense-table">
        <thead>
            <tr>
                <th>Description</th>
                <th>Category</th>
                <th>Base</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Reimbursable?</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="expense-list">
            <!-- Expenses will be loaded here by JavaScript -->
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="pagination">
        <button id="prev-btn" disabled>Previous</button>
        <span id="page-info">Page 1 of 1</span>
        <button id="next-btn" disabled>Next</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State variables
            let currentPage = 1;
            let currentCategory = 'ALL';

            // DOM Elements
            const form = document.getElementById('expense-form');
            const expenseList = document.getElementById('expense-list');
            const formTitle = document.getElementById('form-title');
            const expenseIdInput = document.getElementById('expense-id');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const filterCategorySelect = document.getElementById('filter-category');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInfo = document.getElementById('page-info');

            // Fetch and display expenses based on current state
            async function fetchExpenses() {
                const response = await fetch(`/api/expenses?page=${currentPage}&category=${currentCategory}`);
                const data = await response.json();
                
                expenseList.innerHTML = ''; // Clear existing list
                if (data.expenses) {
                    data.expenses.forEach(expense => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${expense.description}</td>
                            <td>${expense.category}</td>
                            <td>$${expense.base_amount.toFixed(2)}</td>
                            <td>$${expense.tax_amount.toFixed(2)}</td>
                            <td><b>$${expense.total_amount.toFixed(2)}</b></td>
                            <td>${expense.is_reimbursable ? 'Yes' : 'No'}</td>
                            <td>
                                <button onclick="editExpense(${expense.id})">Edit</button>
                                <button onclick="deleteExpense(${expense.id})">Delete</button>
                            </td>
                        `;
                        expenseList.appendChild(row);
                    });
                }

                // Update pagination controls
                pageInfo.textContent = `Page ${data.current_page} of ${data.total_pages}`;
                prevBtn.disabled = !data.has_prev;
                nextBtn.disabled = !data.has_next;
            }

            // --- Event Listeners ---
            filterCategorySelect.addEventListener('change', function() {
                currentCategory = this.value;
                currentPage = 1; // Reset to first page when filter changes
                fetchExpenses();
            });

            prevBtn.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    fetchExpenses();
                }
            });

            nextBtn.addEventListener('click', function() {
                currentPage++;
                fetchExpenses();
            });

            // Handle form submission for both creating and updating
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const id = expenseIdInput.value;
                const url = id ? `/api/expenses/${id}` : '/api/expenses';
                const method = id ? 'PUT' : 'POST';

                const formData = {
                    description: document.getElementById('description').value,
                    base_amount: parseFloat(document.getElementById('base_amount').value),
                    tax_amount: parseFloat(document.getElementById('tax_amount').value),
                    category: document.getElementById('category').value,
                    is_reimbursable: document.getElementById('is_reimbursable').checked
                };

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    form.reset();
                    expenseIdInput.value = '';
                    formTitle.innerText = 'Add New Expense';
                    cancelEditBtn.style.display = 'none';
                    // Reset to first page and fetch to see the new item
                    currentPage = 1; 
                    await fetchExpenses();
                } else {
                    alert('Failed to save expense.');
                }
            });

            // Make functions global so inline onclick can find them
            window.editExpense = async function(id) {
                // To get the expense data, we'll fetch it directly
                const response = await fetch(`/api/expenses?page=1&category=ALL`); // Fetch all to find it
                const data = await response.json();
                const expense = data.expenses.find(e => e.id === id);

                if (expense) {
                    formTitle.innerText = 'Edit Expense';
                    expenseIdInput.value = expense.id;
                    document.getElementById('description').value = expense.description;
                    document.getElementById('base_amount').value = expense.base_amount;
                    document.getElementById('tax_amount').value = expense.tax_amount;
                    document.getElementById('category').value = expense.category.toUpperCase();
                    document.getElementById('is_reimbursable').checked = expense.is_reimbursable;
                    cancelEditBtn.style.display = 'inline-block';
                    window.scrollTo(0, 0);
                }
            }

            window.deleteExpense = async function(id) {
                if (confirm('Are you sure you want to delete this expense?')) {
                    const response = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        // After deleting, refetch the current page
                        await fetchExpenses();
                    } else {
                        alert('Failed to delete expense.');
                    }
                }
            }
            
            cancelEditBtn.addEventListener('click', function() {
                form.reset();
                expenseIdInput.value = '';
                formTitle.innerText = 'Add New Expense';
                cancelEditBtn.style.display = 'none';
            });

            // Initial load
            fetchExpenses();
        });
    </script>
</body>
</html>
