<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - Dashboard</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .form-container { padding: 20px; border: 1px solid #ccc; margin-bottom: 20px; }
        .logout { float: right; }
    </style>
</head>
<body>

    <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    <h1>Welcome, {{ user.username }}!</h1>
    <p>Track and manage your expenses below.</p>

    <!-- Form for Adding/Editing Expenses -->
    <div class="form-container">
        <h2 id="form-title">Add New Expense</h2>
        <form id="expense-form">
            <input type="hidden" id="expense-id">
            
            <label for="description">Description:</label><br>
            <input type="text" id="description" name="description" required size="50"><br><br>

            <label for="base_amount">Base Amount ($):</label><br>
            <input type="number" id="base_amount" name="base_amount" step="0.01" required><br><br>

            <label for="tax_amount">Tax Amount ($):</label><br>
            <input type="number" id="tax_amount" name="tax_amount" step="0.01" value="0.00" required><br><br>

            <label for="category">Category:</label><br>
            <select id="category" name="category" required>
                {% for cat in categories %}
                <option value="{{ cat.upper() }}">{{ cat }}</option>
                {% endfor %}
            </select><br><br>

            <input type="checkbox" id="is_reimbursable" name="is_reimbursable">
            <label for="is_reimbursable">Is this reimbursable?</label><br><br>

            <button type="submit">Save Expense</button>
            <button type="button" id="cancel-edit" style="display:none;">Cancel Edit</button>
        </form>
    </div>

    <!-- Table to Display Expenses -->
    <h2>Your Expenses</h2>
    <table id="expense-table">
        <thead>
            <tr>
                <th>Description</th>
                <th>Category</th>
                <th>Base</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Reimbursable?</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="expense-list">
            <!-- Expenses will be loaded here by JavaScript -->
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('expense-form');
            const expenseList = document.getElementById('expense-list');
            const formTitle = document.getElementById('form-title');
            const expenseIdInput = document.getElementById('expense-id');
            const cancelEditBtn = document.getElementById('cancel-edit');

            // Fetch and display all expenses on page load
            async function fetchExpenses() {
                const response = await fetch('/api/expenses');
                const expenses = await response.json();
                
                expenseList.innerHTML = ''; // Clear existing list
                expenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${expense.description}</td>
                        <td>${expense.category}</td>
                        <td>$${expense.base_amount.toFixed(2)}</td>
                        <td>$${expense.tax_amount.toFixed(2)}</td>
                        <td><b>$${expense.total_amount.toFixed(2)}</b></td>
                        <td>${expense.is_reimbursable ? 'Yes' : 'No'}</td>
                        <td>
                            <button onclick="editExpense(${expense.id})">Edit</button>
                            <button onclick="deleteExpense(${expense.id})">Delete</button>
                        </td>
                    `;
                    expenseList.appendChild(row);
                });
            }

            // Handle form submission for both creating and updating
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                const id = expenseIdInput.value;
                const url = id ? `/api/expenses/${id}` : '/api/expenses';
                const method = id ? 'PUT' : 'POST';

                const formData = {
                    description: document.getElementById('description').value,
                    base_amount: parseFloat(document.getElementById('base_amount').value),
                    tax_amount: parseFloat(document.getElementById('tax_amount').value),
                    category: document.getElementById('category').value,
                    is_reimbursable: document.getElementById('is_reimbursable').checked
                };

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    form.reset();
                    expenseIdInput.value = '';
                    formTitle.innerText = 'Add New Expense';
                    cancelEditBtn.style.display = 'none';
                    await fetchExpenses();
                } else {
                    alert('Failed to save expense.');
                }
            });
